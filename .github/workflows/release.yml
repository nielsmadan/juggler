name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Import Developer ID certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/developer_id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/release.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"

          echo "$DEVELOPER_ID_CERT_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Archive
        run: |
          mkdir -p release
          xcodebuild -scheme Juggler -configuration Release \
            -archivePath release/Juggler.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            archive

      - name: Export with Developer ID signing
        run: |
          xcodebuild -exportArchive \
            -archivePath release/Juggler.xcarchive \
            -exportPath release/export \
            -exportOptionsPlist ExportOptions.plist

          echo "Verifying code signature..."
          codesign -dv --verbose=2 release/export/Juggler.app

      - name: Create ZIP
        run: cd release/export && zip -r -y ../Juggler.zip Juggler.app

      - name: Notarize
        env:
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
        run: |
          xcrun notarytool submit release/Juggler.zip \
            --apple-id "$NOTARIZATION_APPLE_ID" \
            --password "$NOTARIZATION_PASSWORD" \
            --team-id "$NOTARIZATION_TEAM_ID" \
            --wait

          echo "Stapling notarization ticket..."
          xcrun stapler staple release/export/Juggler.app

          echo "Re-creating ZIP with stapled app..."
          rm -f release/Juggler.zip
          cd release/export && zip -r -y ../Juggler.zip Juggler.app

      - name: Compute SHA256
        run: |
          SHA256=$(shasum -a 256 release/Juggler.zip | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> "$GITHUB_ENV"
          echo "SHA256: $SHA256"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$GITHUB_REF_NAME" release/Juggler.zip \
            --title "Juggler $VERSION" \
            --generate-notes

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/nielsmadan/homebrew-juggler.git" \
            "$RUNNER_TEMP/homebrew-juggler"

          CASK_FILE="$RUNNER_TEMP/homebrew-juggler/Casks/juggler.rb"

          sed -i '' "s/version \".*\"/version \"$VERSION\"/" "$CASK_FILE"
          sed -i '' "s/sha256 \".*\"/sha256 \"$SHA256\"/" "$CASK_FILE"

          cd "$RUNNER_TEMP/homebrew-juggler"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/juggler.rb
          git commit -m "Update Juggler to $VERSION"
          git push

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
