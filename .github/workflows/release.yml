name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Import Developer ID certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/developer_id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/release.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"

          echo "$DEVELOPER_ID_CERT_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Archive
        env:
          TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
        run: |
          mkdir -p release
          xcodebuild -scheme Juggler -configuration Release \
            -archivePath release/Juggler.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            archive

      - name: Export with Developer ID signing
        run: |
          xcodebuild -exportArchive \
            -archivePath release/Juggler.xcarchive \
            -exportPath release/export \
            -exportOptionsPlist ExportOptions.plist

          echo "Verifying code signature..."
          codesign -dv --verbose=2 release/export/Juggler.app

      - name: Create ZIP
        run: cd release/export && zip -r -y ../Juggler.zip Juggler.app

      - name: Notarize
        env:
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
        run: |
          xcrun notarytool submit release/Juggler.zip \
            --apple-id "$NOTARIZATION_APPLE_ID" \
            --password "$NOTARIZATION_PASSWORD" \
            --team-id "$NOTARIZATION_TEAM_ID" \
            --wait

          echo "Stapling notarization ticket..."
          xcrun stapler staple release/export/Juggler.app

          echo "Re-creating ZIP with stapled app..."
          rm -f release/Juggler.zip
          cd release/export && zip -r -y ../Juggler.zip Juggler.app

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Juggler" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 100 \
            --icon "Juggler.app" 180 190 \
            --hide-extension "Juggler.app" \
            --app-drop-link 480 190 \
            release/Juggler.dmg \
            release/export/

      - name: Notarize DMG
        env:
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
        run: |
          xcrun notarytool submit release/Juggler.dmg \
            --apple-id "$NOTARIZATION_APPLE_ID" \
            --password "$NOTARIZATION_PASSWORD" \
            --team-id "$NOTARIZATION_TEAM_ID" \
            --wait
          xcrun stapler staple release/Juggler.dmg

      - name: Compute SHA256
        run: |
          SHA256=$(shasum -a 256 release/Juggler.zip | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> "$GITHUB_ENV"
          echo "SHA256 (ZIP): $SHA256"

          DMG_SHA256=$(shasum -a 256 release/Juggler.dmg | cut -d' ' -f1)
          echo "DMG_SHA256=$DMG_SHA256" >> "$GITHUB_ENV"
          echo "SHA256 (DMG): $DMG_SHA256"

      - name: Download Sparkle tools
        run: |
          SPARKLE_VERSION="2.8.1"
          curl -L -o /tmp/Sparkle.tar.xz \
            "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
          mkdir -p /tmp/sparkle
          tar -xf /tmp/Sparkle.tar.xz -C /tmp/sparkle

      - name: Sign update with EdDSA
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          ED_SIGNATURE=$(echo "$SPARKLE_PRIVATE_KEY" | /tmp/sparkle/bin/sign_update --ed-key-file - -p release/Juggler.zip)
          echo "ED_SIGNATURE=$ED_SIGNATURE" >> "$GITHUB_ENV"

          ZIP_LENGTH=$(stat -f%z release/Juggler.zip)
          echo "ZIP_LENGTH=$ZIP_LENGTH" >> "$GITHUB_ENV"

          echo "EdDSA signature: $ED_SIGNATURE"
          echo "ZIP length: $ZIP_LENGTH"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$GITHUB_REF_NAME" release/Juggler.zip release/Juggler.dmg \
            --title "Juggler $VERSION" \
            --generate-notes

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/nielsmadan/homebrew-juggler.git" \
            "$RUNNER_TEMP/homebrew-juggler"

          CASK_FILE="$RUNNER_TEMP/homebrew-juggler/Casks/juggler.rb"

          sed -i '' "s/version \".*\"/version \"$VERSION\"/" "$CASK_FILE"
          sed -i '' "s/sha256 \".*\"/sha256 \"$DMG_SHA256\"/" "$CASK_FILE"
          sed -i '' "s/Juggler\.zip/Juggler.dmg/" "$CASK_FILE"

          cd "$RUNNER_TEMP/homebrew-juggler"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/juggler.rb
          git commit -m "Update Juggler to $VERSION"
          git push

      - name: Update Sparkle appcast
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DOWNLOAD_URL="https://github.com/nielsmadan/juggler/releases/download/${GITHUB_REF_NAME}/Juggler.zip"
          PUB_DATE=$(date -u "+%a, %d %b %Y %H:%M:%S +0000")

          git clone --branch main --single-branch \
            "https://x-access-token:${GH_TOKEN}@github.com/nielsmadan/juggler.git" \
            "$RUNNER_TEMP/appcast-repo"

          python3 <<PYEOF
          import os
          new_item = (
              '        <item>\n'
              '            <title>Version $VERSION</title>\n'
              '            <sparkle:version>$VERSION</sparkle:version>\n'
              '            <pubDate>$PUB_DATE</pubDate>\n'
              '            <enclosure url="$DOWNLOAD_URL"'
              ' length="$ZIP_LENGTH" type="application/octet-stream"'
              ' sparkle:edSignature="$ED_SIGNATURE" />\n'
              '        </item>\n'
          )
          path = os.path.join("$RUNNER_TEMP", "appcast-repo", "appcast.xml")
          with open(path) as f:
              content = f.read()
          content = content.replace("    </channel>", new_item + "    </channel>")
          with open(path, "w") as f:
              f.write(content)
          PYEOF

          cd "$RUNNER_TEMP/appcast-repo"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "chore: update appcast for v${VERSION}"
          git push

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
